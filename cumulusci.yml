minimum_cumulusci_version: "2.5.8"
project:
    name: core-sfdo-performance-tests
    package:
        name: core-sfdo-performance-tests

tasks:
    test_performance:
        description: Runs Robot Framework performance tests for basic SObjects
        class_path: cumulusci.tasks.robotframework.Robot
        group: Performance Tests

    test_performance_demo:
        class_path: cumulusci.tasks.robotframework.Robot
        options:
            suites: robot/core-sfdo-performance-tests
            test: Perftest - Insert 200 Contacts


    snowfakery:
        class_path: tasks.snowscale.Snowfakery
        options:
            num_records: 25_000
            recipe: datasets/basic-salesforce.recipe.yml
            num_records_tablename: Account
            subtask_type: process

    disable_duplicate_rules:
        class_path: cumulusci.tasks.metadata_etl.SetDuplicateRuleStatus
        options:
            active: False
            api_names: "*"

    delete_data:
        options:
            objects:
                - Account
                - Contact
                - Opportunity
                - ContentDocument
            ignore_row_errors: True
            hardDelete: True

flows:
    setup_org_common:
        steps:
            1:
                task: disable_duplicate_rules

            2:
                task: deploy_post

            4:
                task: update_admin_profile

    setup_ldv_org:
        steps:
            1: 
                flow: setup_org_common

            2:
                task: create_bulk_data_permission_set
                ignore_failure: True
                options:
                    user_permissions: PermissionsBulkApiHardDelete

            3:
                task: assign_permission_sets
                options:
                    api_names: CumulusCI_Bulk_Data

    test_performance_scratch:
        steps:
            1:
                flow: setup_org_common
            5:
                task: snowfakery
            6:
                task: test_performance_demo

    test_performance_LDV:
        steps:
            2:
                task: delete_data
            3:
                task: snowfakery
                options:
                    num_records: 30_000_000

            4:
                task: test_performance_demo
                options:
                    suites: robot/core-sfdo-performance-tests
